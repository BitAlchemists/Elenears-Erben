(function(e){e.fn.range=function(){return e.Range(this[0])};var p=function(a){return a.replace(/([a-z])([a-z]+)/gi,function(b,d,c){return d+c.toLowerCase()}).replace(/_/g,"")},s=function(a){return a.replace(/^([a-z]+)_TO_([a-z]+)/i,function(b,d,c){return c+"_TO_"+d})},q=function(a){return a?a.ownerDocument.defaultView||a.ownerDocument.parentWindow:window},r={};e.Range=function(a){if(this.constructor!==e.Range)return new e.Range(a);if(a&&a.jquery)a=a[0];if(!a||a.nodeType){this.win=q(a);this.range=
this.win.document.createRange?this.win.document.createRange():this.win.document.body.createTextRange();a&&this.select(a)}else if(a.clientX!=null||a.pageX!=null||a.left!=null)this.moveToPoint(a);else if(a.originalEvent&&a.originalEvent.touches&&a.originalEvent.touches.length)this.moveToPoint(a.originalEvent.touches[0]);else if(a.originalEvent&&a.originalEvent.changedTouches&&a.originalEvent.changedTouches.length)this.moveToPoint(a.originalEvent.changedTouches[0]);else this.range=a};e.Range.current=
function(a){a=q(a);var b;if(a.getSelection){b=a.getSelection();return new e.Range(b.rangeCount?b.getRangeAt(0):a.document.createRange())}else return new e.Range(a.document.selection.createRange())};e.extend(e.Range.prototype,{moveToPoint:function(a){var b=a.clientX,d=a.clientY;if(!b){d=o();b=(a.pageX||a.left||0)-d.left;d=(a.pageY||a.top||0)-d.top}if(r.moveToPoint){this.range=e.Range().range;this.range.moveToPoint(b,d);return this}for(var c=document.elementFromPoint(b,d),f=0;f<c.childNodes.length;f++){var h=
c.childNodes[f];if(h.nodeType===3||h.nodeType===4){h=e.Range(h);for(var j=h.toString().length,g=1;g<j+1;g++){var i=h.end(g).rect();if(i.left<=b&&i.left+i.width>=b&&i.top<=d&&i.top+i.height>=d){h.start(g-1);this.range=h.range;return}}}}var k;l(c.childNodes,function(m){m=e.Range(m);if(m.rect().top>a.clientY)return false;else k=m});if(k){k.start(k.toString().length);this.range=k.range}else this.range=e.Range(c).range},window:function(){return this.win||window},overlaps:function(a){if(a.nodeType)a=e.Range(a).select(a);
var b=this.compare("START_TO_START",a),d=this.compare("END_TO_END",a);if(b<=0&&d>=0)return true;if(b>=0&&this.compare("START_TO_END",a)<=0)return true;if(this.compare("END_TO_START",a)>=0&&d<=0)return true;return false},collapse:function(a){this.range.collapse(a===undefined?true:a);return this},toString:function(){return typeof this.range.text=="string"?this.range.text:this.range.toString()},start:function(a){if(a===undefined)if(this.range.startContainer)return{container:this.range.startContainer,
offset:this.range.startOffset};else{a=this.clone().collapse().parent();var b=e.Range(a).select(a).collapse();b.move("END_TO_START",this);return{container:a,offset:b.toString().length}}else{if(this.range.setStart)if(typeof a=="number")this.range.setStart(this.range.startContainer,a);else typeof a=="string"?this.range.setStart(this.range.startContainer,this.range.startOffset+parseInt(a,10)):this.range.setStart(a.container,a.offset);else throw"todo";return this}},end:function(a){if(a===undefined)if(this.range.startContainer)return{container:this.range.endContainer,
offset:this.range.endOffset};else{a=this.clone().collapse(false).parent();var b=e.Range(a).select(a).collapse();b.move("END_TO_END",this);return{container:a,offset:b.toString().length}}else{if(this.range.setEnd)typeof a=="number"?this.range.setEnd(this.range.endContainer,a):this.range.setEnd(a.container,a.offset);else throw"todo";return this}},parent:function(){if(this.range.commonAncestorContainer)return this.range.commonAncestorContainer;else{var a=this.range.parentElement(),b=this.range;l(a.childNodes,
function(d){if(e.Range(d).range.inRange(b)){a=d;return false}});return a}},rect:function(a){var b=this.range.getBoundingClientRect();if(a==="page"){a=o();b=e.extend({},b);b.top+=a.top;b.left+=a.left}return b},rects:function(a){for(var b=e.makeArray(this.range.getClientRects()).sort(function(g,i){return i.width*i.height-g.width*g.height}),d=0,c;d<b.length;){var f=b[d],h=false;c=d+1;for(c=d+1;c<b.length;c++)if(t(f,b[c])){h=b[c];break}if(h)b.splice(d,1);else d++}if(a=="page"){var j=o();return e.map(b,
function(g){g=e.extend({},g);g.top+=j.top;g.left+=j.left;return g})}return b}});(function(){var a=e.Range.prototype,b=e.Range().range;a.compare=b.compareBoundaryPoints?function(c,f){return this.range.compareBoundaryPoints(this.window().Range[s(c)],f.range)}:function(c,f){return this.range.compareEndPoints(p(c),f.range)};a.move=b.setStart?function(c,f){f=f.range;switch(c){case "START_TO_END":this.range.setStart(f.endContainer,f.endOffset);break;case "START_TO_START":this.range.setStart(f.startContainer,
f.startOffset);break;case "END_TO_END":this.range.setEnd(f.endContainer,f.endOffset);break;case "END_TO_START":this.range.setEnd(f.startContainer,f.startOffset);break}return this}:function(c,f){this.range.setEndPoint(p(c),f.range);return this};var d=b.cloneRange?"cloneRange":"duplicate";a.clone=function(){return e.Range(this.range[d]())};a.select=b.selectNodeContents?function(c){c?this.range.selectNodeContents(c):this.window().getSelection().addRange(this.range);return this}:function(c){if(c)if(c.nodeType===
3){var f=c.parentNode,h=0,j;l(f.childNodes,function(g){if(g===c){j=h+g.nodeValue.length;return false}else h+=g.nodeValue.length});this.range.moveToElementText(f);this.range.moveEnd("character",j-this.range.text.length);this.range.moveStart("character",h)}else this.range.moveToElementText(c);else this.range.select();return this}})();var l=function(a,b){for(var d,c=0;a[c];c++){d=a[c];if(d.nodeType===3||d.nodeType===4){if(b(d)===false)return false}else if(d.nodeType!==8)if(l(d.childNodes,b)===false)return false}},
n=function(a,b){return a.left<=b.clientX&&a.left+a.width>=b.clientX&&a.top<=b.clientY&&a.top+a.height>=b.clientY},t=function(a,b){return n(a,{clientX:b.left,clientY:b.top})&&n(a,{clientX:b.left+b.width,clientY:b.top})&&n(a,{clientX:b.left,clientY:b.top+b.height})&&n(a,{clientX:b.left+b.width,clientY:b.top+b.height})},o=function(a){a=a||window;doc=a.document.documentElement;body=a.document.body;return{left:(doc&&doc.scrollLeft||body&&body.scrollLeft||0)+(doc.clientLeft||0),top:(doc&&doc.scrollTop||
body&&body.scrollTop||0)+(doc.clientTop||0)}};r.moveToPoint=!!e.Range().range.moveToPoint})(jQuery);
