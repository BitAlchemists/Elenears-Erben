(function(f){var m=/\:([\w\.]+)/g,n=/^(?:&[^=]+=[^&]*)+/,r=function(a){var b=[],c,d;for(c in a){d=a[c];if(c==="className")c="class";d&&b.push(o(c),'="',o(d),'" ')}return b.join("")},o=function(a){return a.replace(/"/g,"&#34;").replace(/'/g,"&#39;")},s=function(a,b){for(var c=0,d=0;d<a.names.length;d++){if(!b.hasOwnProperty(a.names[d]))return-1;c++}return c},p=true,h=window.location,e=f.route=function(a,b){var c=[],d=a.replace(m,function(i,g){c.push(g);return"([\\w\\.]*)"});e.routes[a]={test:new RegExp("^"+
d),route:a,names:c,defaults:b||{},length:a.split("/").length};return e};f.extend(e,{param:function(a){var b,c=-1,d,i;for(var g in e.routes){d=e.routes[g];i=s(d,a);if(i>c){b=d;c=i}}if(b){var j=f.extend({},a);c=b.route.replace(m,function(t,k){delete j[k];return a[k]===b.defaults[k]?"":a[k]});for(g in b.defaults)j[g]===b.defaults[g]&&delete j[g];g=f.param(j);return c+(g?"&"+g:"")}return f.isEmptyObject(a)?"":"&"+f.param(a)},deparam:function(a){var b={length:-1};for(var c in e.routes){var d=e.routes[c];
if(d.test.test(a)&&d.length>b.length)b=d}if(b.length>-1){c=a.match(b.test);d=c.shift();a=(a=a.substr(d.length))&&n.test(a)?f.String.deparam(a.slice(1)):{};a=f.extend(true,{},b.defaults,a);for(d=0;d<c.length;d++)if(c[d])a[b.names[d]]=c[d];return a}return n.test(a)?f.String.deparam(a.slice(1)):{}},data:new f.Observe({}),routes:{},ready:function(a){if(a===false)p=false;if(a===true||p===true)q();return e},url:function(a,b){return b?"#!"+e.param(f.extend({},l,a)):"#!"+e.param(a)},link:function(a,b,c,d){return"<a "+
r(f.extend({href:e.url(b,d)},c))+">"+a+"</a>"},current:function(a){return h.hash=="#!"+e.param(a)},set:function(a,b){if(f.isPlainObject(a))e.attrs(a,typeof b=="undefined"?true:b);else if(typeof a=="string"){b="";if(a[0]!="!"&&a[1]!="!")b="#!";h.hash=b+a}return e}});f(function(){f.route.ready()});f.each(["bind","unbind","delegate","undelegate","attr","attrs","serialize","removeAttr"],function(a,b){e[b]=function(){return e.data[b].apply(e.data,arguments)}});var l,q=function(){var a=h.hash.substr(1,
1)==="!"?h.hash.slice(2):h.hash.slice(1);l=e.deparam(a);e.attrs(l,true)};f(window).bind("hashchange",q);e.data.bind("change",function(a,b){var c;return function(){clearTimeout(c);c=setTimeout(a,b||1)}}(function(){h.hash="#!"+e.param(e.data.serialize())}))})(jQuery);
